@using BudgetAnalyzer.Shared.Data
@namespace BudgetAnalyzer.Shared.Controls
@inherits SubscribedComponent

<MudTable T="BudgetCategory" Items="State.SelectedBudget.Categories" Hover="true" Elevation="0">
    <ToolBarContent>
        <MudNumericField Label="Paycheck Amount" Min="0" Step="50" Immediate="true" @bind-Value=PaycheckAmount
                         Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
        <MudSpacer />
        
        <MudSwitch Label="Respect Cutoffs: " LabelPosition="LabelPosition.Start" Color="Color.Primary" @bind-Value=RespectCutoffs />
    </ToolBarContent>

    <HeaderContent>
        <MudTh>Name</MudTh>
        @if(RespectCutoffs)
        {
            <MudTh>Current Balance</MudTh>
        }
        <MudTh>
            <MudTooltip Text="The amount to assign to each budget. '*' = cutoff is reached">
                Assigned Amount
            </MudTooltip>
        </MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        @if (RespectCutoffs)
        {
            <MudTd DataLabel="Current Balance">
                <MudNumericField @bind-Value=@(CategoryBalances[context.Id]) Immediate=true />
            </MudTd>
        }
        <MudTd DataLabel="Assigned Amount">@CalculateAssignment(context).ToString("C") @(CutoffReached(context) ? "*" : "")</MudTd>
    </RowTemplate>
</MudTable>
<MudStack Row="true">
@if (RespectCutoffs)
{
   <MudText>Unassigned Amount: @CalculateLeftovers().ToString("C")</MudText> 
}
<MudSpacer />

<MudButton Color="Color.Info" OnClick="SetPageToDefault">Reset</MudButton> 
</MudStack>
<MudButton OnClick="DoNothing">Debug</MudButton>

@code {
    private decimal PaycheckAmount { get; set; }
    private bool RespectCutoffs { get; set; } = true;

    private Dictionary<Guid, decimal> CategoryBalances { get; set; } = default!;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        SetPageToDefault();
    }

    private decimal CalculateAssignment(BudgetCategory category)
    {
        if (!RespectCutoffs || category.Cutoff is not decimal cutoff)
            return category.Percentage.PercentOf(PaycheckAmount);

        decimal baseAssignment = category.Percentage.PercentOf(PaycheckAmount);
        decimal proposedTotal = CategoryBalances[category.Id] + baseAssignment;

        if (proposedTotal <= cutoff) return baseAssignment;
        return Math.Max(0, cutoff - CategoryBalances[category.Id]);  // If the current total is over the cutoff, don't take out money
    }

    private bool CutoffReached(BudgetCategory category) => (CategoryBalances[category.Id] + CalculateAssignment(category)) >= category.Cutoff;
    private decimal CalculateLeftovers() => PaycheckAmount - State.SelectedBudget.Categories.Sum(c => CalculateAssignment(c));

    private void SetPageToDefault()
    {
        PaycheckAmount = 0;
        CategoryBalances = State.SelectedBudget.Categories.ToDictionary(c => c.Id, c => 0M);
    }

    private void DoNothing() { 
}

}
